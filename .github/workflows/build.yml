name: build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build_go:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        target:
          - cli
          - agent
          - sysd
          # Browser support is always included in the agent bundle
          # - browser_support
        platform:
          - macos-15
          - ubuntu-24.04
          - ubuntu-24.04-arm
          - windows-2025
        exclude:
          # CLI and sysd are included in the agent bundle
          - target: sysd
            platform: macos-15
          - target: cli
            platform: macos-15
          # CLI and sysd are included in the agent bundle
          - target: sysd
            platform: windows-2025
          - target: cli
            platform: windows-2025
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version-file: go.mod
          cache: true
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
      - id: platform_pure
        shell: bash
        run: |
          platform=$(uname -o | tr '[:upper:]' '[:lower:]')
          echo "platform=${platform}" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
        with:
          path: cache/
          key: target-cache-${{ matrix.target }}-${{ matrix.platform }}

      # macOS Specific
      - uses: ./.github/actions/macos-signing
        if: ${{ steps.platform_pure.outputs.platform == 'darwin' }}
        with:
          p12-file-base64: ${{ secrets.APPLE_SIGN_CERT }}
          p12-password: ${{ secrets.APPLE_SIGN_CERT_PASSWORD }}
          ac-issuer: ${{ secrets.APPLE_AC_ISSUER }}
          ac-kid: ${{ secrets.APPLE_AC_KID }}
          ac-key: ${{ secrets.APPLE_AC_KEY }}
      # Windows Specific
      - uses: ilammy/msvc-dev-cmd@v1
        if: ${{ steps.platform_pure.outputs.platform == 'msys' }}
        with:
          arch: amd64

      - shell: bash
        run: make ${{ matrix.target }}/package-${{ steps.platform_pure.outputs.platform }}
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: authentik_${{ matrix.platform }}_${{ matrix.target }}
          path: bin/
  build_js:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        target:
          - browser-ext
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version-file: "${{ matrix.target }}/package.json"
          cache: "npm"
          cache-dependency-path: "${{ matrix.target }}/package-lock.json"
      - run: make ${{ matrix.target }}/package
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: authentik_${{ matrix.target }}
          path: bin/
  build_rs:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        target:
          - pam
          - nss
        platform:
          - ubuntu-24.04
          - ubuntu-24.04-arm
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version-file: go.mod
          cache: true
      - run: |
          sudo apt-get update
          sudo apt-get install -y libpam0g-dev
      - uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
        with:
          path: cache/
          key: target-cache-${{ matrix.target }}-${{ matrix.platform }}
      - run: make ${{ matrix.target }}/build
      - run: make ${{ matrix.target }}/package
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: authentik_${{ matrix.platform }}_${{ matrix.target }}
          path: bin/
  deploy:
    needs:
      - build_go
      - build_js
      - build_rs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v6
        with:
          path: ./bin
      - run: |
          sudo apt-get remove --purge man-db
      - uses: ./.github/actions/repo
        id: repo
        with:
          package-path: bin/
          gpg-private-key: "${{ secrets.GPG_PRIVATE }}"
      - name: Upload repository
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: repo
          path: ./repo
      - name: Upload packages
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: all-packages
          path: ./bin
  deploy-to-netlify:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Determine component name
        id: component
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "component=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
          else
            echo "component=main" >> $GITHUB_OUTPUT
          fi
      - name: Download repository
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v6
        with:
          name: repo
          path: ./deploy
      - name: Download packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v6
        with:
          name: all-packages
          path: ./deploy/packages
      - id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@4cbaf4c08f1a7bfa537d6113472ef4424e4eb654 # v3.0
        with:
          publish-dir: './deploy'
          production-branch: main
          github-token: ${{ steps.app-token.outputs.token }}
          deploy-message: "Repo: ${{ github.event_name == 'pull_request' && format('PR #{0}', github.event.number) || 'main' }}"
          alias: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || '' }}
          github-deployment-environment: pkg
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: authentik-pkg.netlify.app
