name: build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build_go:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        target:
          - cli
          - agent
          - sysd
          # Browser support is always included in the agent bundle
          # - browser_support
        platform:
          - macos-15
          - ubuntu-24.04
          - ubuntu-24.04-arm
          - windows-2025
        exclude:
          # CLI and sysd are included in the agent bundle
          - target: sysd
            platform: macos-15
          - target: cli
            platform: macos-15
          # CLI and sysd are included in the agent bundle
          - target: sysd
            platform: windows-2025
          - target: cli
            platform: windows-2025
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version-file: go.mod
          cache: true
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
      - id: platform_pure
        shell: bash
        run: |
          platform=$(uname -o | tr '[:upper:]' '[:lower:]')
          echo "platform=${platform}" >> "$GITHUB_OUTPUT"
      - uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
        with:
          path: cache/
          key: target-cache-${{ matrix.target }}-${{ matrix.platform }}

      # macOS Specific
      - uses: ./.github/actions/macos-signing
        if: ${{ steps.platform_pure.outputs.platform == 'darwin' }}
        with:
          p12-file-base64: ${{ secrets.APPLE_SIGN_CERT }}
          p12-password: ${{ secrets.APPLE_SIGN_CERT_PASSWORD }}
          ac-issuer: ${{ secrets.APPLE_AC_ISSUER }}
          ac-kid: ${{ secrets.APPLE_AC_KID }}
          ac-key: ${{ secrets.APPLE_AC_KEY }}
      # Windows Specific
      - uses: ilammy/msvc-dev-cmd@v1
        if: ${{ steps.platform_pure.outputs.platform == 'msys' }}
        with:
          arch: amd64

      - shell: bash
        run: make ${{ matrix.target }}/package-${{ steps.platform_pure.outputs.platform }}
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: authentik_${{ matrix.platform }}_${{ matrix.target }}
          path: bin/
  build_js:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        target:
          - browser-ext
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version-file: "${{ matrix.target }}/package.json"
          cache: "npm"
          cache-dependency-path: "${{ matrix.target }}/package-lock.json"
      - run: make ${{ matrix.target }}/package
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: authentik_${{ matrix.target }}
          path: bin/
  build_rs:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        target:
          - pam
          - nss
        platform:
          - ubuntu-24.04
          - ubuntu-24.04-arm
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version-file: go.mod
          cache: true
      - run: |
          sudo apt-get update
          sudo apt-get install -y libpam0g-dev
      - uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
        with:
          path: cache/
          key: target-cache-${{ matrix.target }}-${{ matrix.platform }}
      - run: make ${{ matrix.target }}/build
      - run: make ${{ matrix.target }}/package
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: authentik_${{ matrix.platform }}_${{ matrix.target }}
          path: bin/
  build_nix:
    name: Build (Nix)
    strategy:
      fail-fast: false
      matrix:
        platform:
          - ubuntu-24.04
          - ubuntu-24.04-arm
          - macos-15
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: DeterminateSystems/nix-installer-action@v21
      - uses: DeterminateSystems/magic-nix-cache-action@v13
      - uses: ./.github/actions/nix
        id: nix-build
        with:
          signing-key: ${{ secrets.NIX_SIGNING_KEY }}
          output-path: ./nix-cache
      - name: Show build info
        shell: bash
        run: |
          echo "Cache size: $NIX_CACHE_SIZE"
        env:
          NIX_CACHE_SIZE: ${{ steps.nix-build.outputs.cache-size }}
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: nix-cache-${{ matrix.platform }}
          path: ./nix-cache/
  deploy:
    needs:
      - build_go
      - build_js
      - build_rs
      - build_nix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v6
        with:
          path: ./bin
      - run: |
          sudo apt-get remove --purge man-db
      - uses: ./.github/actions/repo
        id: repo
        with:
          package-path: bin/
          gpg-private-key: "${{ secrets.GPG_PRIVATE }}"
      - name: Merge Nix caches
        shell: bash
        run: |
          set -xeuo pipefail
          mkdir -p ./repo/nix/nar

          # Merge all platform caches
          for cache_dir in ./bin/nix-cache-*/; do
            if [ -d "$cache_dir" ]; then
              echo "Merging cache from: $cache_dir"
              # Copy narinfo files (don't overwrite existing)
              find "$cache_dir" -maxdepth 1 -name "*.narinfo" -exec cp -n {} ./repo/nix/ \; 2>/dev/null || true
              # Copy nar archives
              if [ -d "$cache_dir/nar" ]; then
                find "$cache_dir/nar" -name "*.nar*" -exec cp -n {} ./repo/nix/nar/ \; 2>/dev/null || true
              fi
            fi
          done

          # Create unified nix-cache-info
          cat > ./repo/nix/nix-cache-info << EOF
          StoreDir: /nix/store
          WantMassQuery: 1
          Priority: 40
          EOF

          # Show cache stats
          echo "Merged Nix cache:"
          du -sh ./repo/nix
          echo "NAR info files: $(find ./repo/nix -maxdepth 1 -name '*.narinfo' | wc -l)"
          echo "NAR archives: $(find ./repo/nix/nar -name '*.nar*' 2>/dev/null | wc -l)"
      - name: Upload repository
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: repo
          path: ./repo
      - name: Upload packages
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: all-packages
          path: ./bin
  deploy-to-netlify:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    outputs:
      deploy-url: ${{ steps.netlify.outputs.deploy-url }}
    steps:
      - name: Determine component name
        id: component
        shell: bash
        run: |
          if [ "$EVENT_NAME" = "pull_request" ]; then
            echo "component=pr-$EVENT_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "component=main" >> $GITHUB_OUTPUT
          fi
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_NUMBER: ${{ github.event.number }}
      - name: Download repository
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v6
        with:
          name: repo
          path: ./deploy
      - name: Download packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v6
        with:
          name: all-packages
          path: ./deploy/packages
      - name: Show deployment structure
        shell: bash
        run: |
          echo "APT repo size: $(du -sh ./deploy/dists 2>/dev/null | cut -f1 || echo 'N/A')"
          echo "Nix cache size: $(du -sh ./deploy/nix 2>/dev/null | cut -f1 || echo 'N/A')"
      - id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - uses: nwtgck/actions-netlify@4cbaf4c08f1a7bfa537d6113472ef4424e4eb654 # v3.0
        id: netlify
        with:
          publish-dir: './deploy'
          production-branch: main
          github-token: ${{ steps.app-token.outputs.token }}
          deploy-message: "Repo: ${{ github.event_name == 'pull_request' && format('PR #{0}', github.event.number) || 'main' }}"
          alias: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || '' }}
          github-deployment-environment: ${{ github.event_name == 'pull_request' && '' || 'pkg' }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: authentik-pkg.netlify.app
  build-container:
    needs: deploy-to-netlify
    permissions:
      packages: write
    strategy:
      fail-fast: false
      matrix:
        target:
          - selenium
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
      - uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - id: meta
        env:
          AK_DEPLOY_URL: ${{ needs.deploy-to-netlify.outputs.deploy-url }}
          AK_TAG_SUFFIX: ${{ github.event_name == 'pull_request' && github.event.number || '' }}
        run: |
          cd ${{ matrix.target }}
          echo "tag=$(make ci-container-tag)" >> $GITHUB_OUTPUT
          echo "build-args=$(make ci-build-args)" >> $GITHUB_OUTPUT
      - uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        id: push
        with:
          context: ${{ matrix.target }}
          file: ${{ matrix.target }}/Dockerfile
          push: true
          build-args: ${{ steps.meta.outputs.build-args }}
          tags: ${{ steps.meta.outputs.tag }}
          platforms: linux/amd64,linux/arm64
